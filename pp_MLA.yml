---
- name: Configured monitoring, loging and alerting server
  hosts: pp-MLA
  bacome: true
  vars_files: inventory/group_vars/PPvars.yml
  gather_facts: false

  vars:
    grafana_deb: "/packages/grafana-enterprise_12.3.0_19497075765_linux_amd64.deb"
    elasticsearch_deb: "/packages/elasticsearch-9.2.2-amd64.deb"
    logstash_deb: "/packages/logstash-9.2.2-amd64.deb"
    kibana_deb: "/packages/kibana-9.2.2-amd64.deb"

  handlers:
    - name: Restart prometheus
      ansible.builtin.systemd:
        name: prometheus
        state: restarted

    - name: Restart alertmanager
      ansible.builtin.systemd:
        name: prometheus-alertmanager
        state: restarted

    - name: Restart grafana
      ansible.builtin.systemd:
        name: grafana-server
        state: restarted
    
    - name: Restart elasticsearch
      ansible.builtin.systemd:
        name: elasticsearch
        state: restarted

    - name: Restart logstash
      ansible.builtin.systemd:
        name: logstash
        state: restarted

    - name: Restart kibana
      ansible.builtin.systemd:
        name: kibana
        state: restarted

  tasks:
    - name: Ensure prometheus is installed
      ansible.builtin.apt:
        name:
          - prometheus
          - prometheus-alertmanager
        state: present
        update_cache: true
  
    - name: Copy prometheus configs
      ansible.builtin.template:
        src: prometheus.yml.j2
        dest: /etc/prometheus/prometheus.yml
        owner: prometheus
        group: prometheus
        mode: '0600'
      notify: Restart prometheus

    - name: Install deb packages (grafana, ELK, filebeat)
      ansible.builtin.apt:
        deb: "{{ item }}"
      loop:
        - "{{ grafana_deb }}"
        - "{{ elasticsearch_deb }}"
        - "{{ logstash_deb }}"
        - "{{ kibana_deb }}"
        - "{{ filebeat_deb }}"
    
    - name: Copy all config files grafana
      ansible.builtin.copy:
        src: grafana-config.tar.gz
        dest: /tmp/

    - name: Extract grafana directory /etc/grafana
      ansible.builtin.unarchive:
        src: /tmp/grafana-backup.tar.gz
        dest: /
        remote_src: yes
        owner: grafana
        group: grafana
        mode: '0644'
        directory_mode: '0755'
      notify: Restart grafana

    - name: Create config jvm.options
      ansible.builtin.copy:
        dest: /etc/elasticsearch/jvm.options.d/custom_jvm.options
        content: |
          -Xms2g
          -Xmx2g
        owner: root
        group: elasticsearch
        mode: '0644'

    - name: Copy elasticsearch config
      ansible.builtin.template:
        src: elasticsearch.yml.j2
        dest: /etc/elasticsearch/elasticsearch.yml
        owner: root
        group: root
        mode: '0640'
      notify: Restart elasticsearch





...
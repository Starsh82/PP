---
- name: Создание статической конфигурации pp-front в KVM VM из source
  hosts: source
  become: yes
  vars:
    static_ip: "192.168.122.21"
    gateway: "192.168.122.1"
    interface: "enp1s0"
    new_hostname: "pp-back1"

  tasks:

    - name: Установка network tools
      apt:
        name: net-tools
        state: present

    - name: Статическая конфигураци IP для netplan
      copy:
        content: |
          network:
            version: 2
            renderer: networkd
            ethernets:
              {{ interface }}:
                dhcp4: no
                addresses: [{{ static_ip }}/24]
                gateway4: {{ gateway }}
                nameservers:
                  addresses: [192.168.122.1, 8.8.8.8, 8.8.4.4]
        dest: /etc/netplan/50-cloud-init.yaml
        owner: root
        group: root
        mode: 0644

    - name: Проверка имени хоста после перезагрузки
      copy:
        content: "{{ new_hostname }}"
        dest: /etc/hostname
        owner: root
        group: root
        mode: 0644

    - name: Apply network configuration
      ansible.builtin.command: netplan apply  # Применяем новые сетевые настройки через netplan
      async: 10  # Запускаем команду асинхронно с максимальным временем выполнения 45 секунд
      poll: 0    # Не ждем завершения команды, сразу переходим к следующей задаче (ожидаем разрыв соединения)

    - name: Wait for reconnection with reasonable timeout
      ansible.builtin.wait_for_connection:
        connect_timeout: 5  # Таймаут отдельной попытки подключения - 15 секунд
        delay: 5            # Ждем 10 секунд перед первой попыткой переподключения
        timeout: 10          # Общий максимальный таймаут ожидания восстановления соединения - 90 секунд

    - name: Fail playbook if connection not restored
      ansible.builtin.fail:
        msg: "Соединение не восстановилось после netplan apply. Проверьте: 1) Новый IP адрес 2) Сетевой интерфейс 3) SSH демон"
      when: ansible_connection is failed  # Условие срабатывает только если предыдущая задача wait_for_connection завершилась ошибкой
      ...